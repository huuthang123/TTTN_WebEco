{"ast":null,"code":"import React,{useEffect,useState}from\"react\";import{useLocation,useNavigate}from\"react-router-dom\";import{useAuth}from\"../context/AuthContext\";// Thêm useAuth\nimport axios from\"axios\";import\"../styles/Payment.css\";import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const Payment=()=>{const{state}=useLocation();const navigate=useNavigate();const{user}=useAuth();// Lấy user từ AuthContext\nconst[loading,setLoading]=useState(false);const[error,setError]=useState(null);// Kiểm tra dữ liệu từ state và user\nuseEffect(()=>{if(!state||!state.selectedItems||!state.total||state.total<=0){setError(\"Không có sản phẩm nào để thanh toán. Vui lòng quay lại giỏ hàng.\");setTimeout(()=>navigate(\"/cart\"),3000);}if(!user||!user._id){setError(\"Vui lòng đăng nhập để thanh toán.\");setTimeout(()=>navigate(\"/sign-in\"),3000);}},[state,user,navigate]);// Tạo orderInfo từ selectedItems\nconst createOrderInfo=items=>{return items.map(item=>`${item.name} ${item.size} - ${item.quantity} x ${item.price}`).join(\", \");};const handlePayment=async()=>{if(!state||!state.selectedItems||!state.total||!user||!user._id){setError(\"Dữ liệu thanh toán không hợp lệ hoặc bạn chưa đăng nhập.\");return;}const{selectedItems,total,selectedAddress}=state;const orderInfo=createOrderInfo(selectedItems);const amount=total;setLoading(true);setError(null);try{// Gửi request đến VNPay Server (cổng 5001), bao gồm userId\nconst response=await axios.post(\"http://localhost:5001/create_payment\",{userId:user._id,// Thêm userId\namount:amount,orderInfo:orderInfo,items:selectedItems,address:selectedAddress});if(response.data.status===\"success\"){window.location.href=response.data.url;}else{setError(\"Không thể tạo URL thanh toán. Vui lòng thử lại.\");}}catch(error){console.error(\"Lỗi khi tạo URL thanh toán:\",error);setError(\"Đã có lỗi xảy ra. Vui lòng thử lại!\");}finally{setLoading(false);}};if(!state||!state.selectedItems||!state.total||!user||!user._id){return/*#__PURE__*/_jsxs(\"div\",{className:\"payment-container\",children:[/*#__PURE__*/_jsx(\"h2\",{children:\"Thanh to\\xE1n\"}),/*#__PURE__*/_jsx(\"p\",{className:\"error-message\",children:error||\"Đang tải...\"})]});}const{selectedItems,total,selectedAddress}=state;return/*#__PURE__*/_jsxs(\"div\",{className:\"payment-container\",children:[/*#__PURE__*/_jsx(\"h2\",{children:\"Thanh to\\xE1n\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"order-summary\",children:[/*#__PURE__*/_jsx(\"h3\",{children:\"Th\\xF4ng tin \\u0111\\u01A1n h\\xE0ng\"}),/*#__PURE__*/_jsx(\"div\",{className:\"order-items\",children:selectedItems.map(item=>/*#__PURE__*/_jsxs(\"div\",{className:\"order-item\",children:[/*#__PURE__*/_jsx(\"img\",{src:item.image,alt:item.name,className:\"order-item-image\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"order-item-details\",children:[/*#__PURE__*/_jsx(\"p\",{children:/*#__PURE__*/_jsx(\"strong\",{children:item.name})}),/*#__PURE__*/_jsxs(\"p\",{children:[\"Ph\\xE2n lo\\u1EA1i: \",item.color||item.category||\"Không xác định\",\", \",item.size]}),/*#__PURE__*/_jsxs(\"p\",{children:[\"S\\u1ED1 l\\u01B0\\u1EE3ng: \",item.quantity]}),/*#__PURE__*/_jsxs(\"p\",{children:[\"\\u0110\\u01A1n gi\\xE1: \",item.price.toLocaleString(),\"\\u0111\"]}),/*#__PURE__*/_jsxs(\"p\",{children:[\"T\\u1ED5ng: \",(item.price*item.quantity).toLocaleString(),\"\\u0111\"]})]})]},`${item.productId}-${item.size}`))}),/*#__PURE__*/_jsx(\"div\",{className:\"order-total\",children:/*#__PURE__*/_jsxs(\"p\",{children:[\"T\\u1ED5ng thanh to\\xE1n (\",selectedItems.length,\" s\\u1EA3n ph\\u1EA9m):\",\" \",/*#__PURE__*/_jsxs(\"strong\",{children:[total.toLocaleString(),\"\\u0111\"]})]})})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"shipping-address\",children:[/*#__PURE__*/_jsx(\"h3\",{children:\"\\u0110\\u1ECBa ch\\u1EC9 giao h\\xE0ng\"}),selectedAddress?/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:selectedAddress.fullName}),\" (\",selectedAddress.phone,\")\"]}),/*#__PURE__*/_jsx(\"p\",{children:selectedAddress.address})]}):/*#__PURE__*/_jsx(\"p\",{children:\"Ch\\u01B0a c\\xF3 \\u0111\\u1ECBa ch\\u1EC9 giao h\\xE0ng.\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"payment-actions\",children:[error&&/*#__PURE__*/_jsx(\"p\",{className:\"error-message\",children:error}),/*#__PURE__*/_jsx(\"button\",{onClick:handlePayment,disabled:loading||!selectedAddress,className:\"payment-btn\",children:loading?\"Đang xử lý...\":\"Thanh toán với VNPay\"})]})]});};export default Payment;","map":{"version":3,"names":["React","useEffect","useState","useLocation","useNavigate","useAuth","axios","jsx","_jsx","jsxs","_jsxs","Payment","state","navigate","user","loading","setLoading","error","setError","selectedItems","total","setTimeout","_id","createOrderInfo","items","map","item","name","size","quantity","price","join","handlePayment","selectedAddress","orderInfo","amount","response","post","userId","address","data","status","window","location","href","url","console","className","children","src","image","alt","color","category","toLocaleString","productId","length","fullName","phone","onClick","disabled"],"sources":["D:/Năm 4 Kì 2/Phát triển hệ thống thương mại điện tử/ecommerce-app/frontend/src/components/Payment.jsx"],"sourcesContent":["import React, { useEffect, useState } from \"react\";\r\nimport { useLocation, useNavigate } from \"react-router-dom\";\r\nimport { useAuth } from \"../context/AuthContext\"; // Thêm useAuth\r\nimport axios from \"axios\";\r\nimport \"../styles/Payment.css\";\r\n\r\nconst Payment = () => {\r\n  const { state } = useLocation();\r\n  const navigate = useNavigate();\r\n  const { user } = useAuth(); // Lấy user từ AuthContext\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState(null);\r\n\r\n  // Kiểm tra dữ liệu từ state và user\r\n  useEffect(() => {\r\n    if (!state || !state.selectedItems || !state.total || state.total <= 0) {\r\n      setError(\"Không có sản phẩm nào để thanh toán. Vui lòng quay lại giỏ hàng.\");\r\n      setTimeout(() => navigate(\"/cart\"), 3000);\r\n    }\r\n    if (!user || !user._id) {\r\n      setError(\"Vui lòng đăng nhập để thanh toán.\");\r\n      setTimeout(() => navigate(\"/sign-in\"), 3000);\r\n    }\r\n  }, [state, user, navigate]);\r\n\r\n  // Tạo orderInfo từ selectedItems\r\n  const createOrderInfo = (items) => {\r\n    return items\r\n      .map((item) => `${item.name} ${item.size} - ${item.quantity} x ${item.price}`)\r\n      .join(\", \");\r\n  };\r\n\r\n  const handlePayment = async () => {\r\n    if (!state || !state.selectedItems || !state.total || !user || !user._id) {\r\n      setError(\"Dữ liệu thanh toán không hợp lệ hoặc bạn chưa đăng nhập.\");\r\n      return;\r\n    }\r\n\r\n    const { selectedItems, total, selectedAddress } = state;\r\n    const orderInfo = createOrderInfo(selectedItems);\r\n    const amount = total;\r\n\r\n    setLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      // Gửi request đến VNPay Server (cổng 5001), bao gồm userId\r\n      const response = await axios.post(\"http://localhost:5001/create_payment\", {\r\n        userId: user._id, // Thêm userId\r\n        amount: amount,\r\n        orderInfo: orderInfo,\r\n        items: selectedItems,\r\n        address: selectedAddress,\r\n      });\r\n\r\n      if (response.data.status === \"success\") {\r\n        window.location.href = response.data.url;\r\n      } else {\r\n        setError(\"Không thể tạo URL thanh toán. Vui lòng thử lại.\");\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Lỗi khi tạo URL thanh toán:\", error);\r\n      setError(\"Đã có lỗi xảy ra. Vui lòng thử lại!\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  if (!state || !state.selectedItems || !state.total || !user || !user._id) {\r\n    return (\r\n      <div className=\"payment-container\">\r\n        <h2>Thanh toán</h2>\r\n        <p className=\"error-message\">{error || \"Đang tải...\"}</p>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const { selectedItems, total, selectedAddress } = state;\r\n\r\n  return (\r\n    <div className=\"payment-container\">\r\n      <h2>Thanh toán</h2>\r\n\r\n      {/* Hiển thị thông tin đơn hàng */}\r\n      <div className=\"order-summary\">\r\n        <h3>Thông tin đơn hàng</h3>\r\n        <div className=\"order-items\">\r\n          {selectedItems.map((item) => (\r\n            <div key={`${item.productId}-${item.size}`} className=\"order-item\">\r\n              <img src={item.image} alt={item.name} className=\"order-item-image\" />\r\n              <div className=\"order-item-details\">\r\n                <p>\r\n                  <strong>{item.name}</strong>\r\n                </p>\r\n                <p>Phân loại: {item.color || item.category || \"Không xác định\"}, {item.size}</p>\r\n                <p>Số lượng: {item.quantity}</p>\r\n                <p>Đơn giá: {item.price.toLocaleString()}đ</p>\r\n                <p>Tổng: {(item.price * item.quantity).toLocaleString()}đ</p>\r\n              </div>\r\n            </div>\r\n          ))}\r\n        </div>\r\n        <div className=\"order-total\">\r\n          <p>\r\n            Tổng thanh toán ({selectedItems.length} sản phẩm):{\" \"}\r\n            <strong>{total.toLocaleString()}đ</strong>\r\n          </p>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Hiển thị địa chỉ giao hàng */}\r\n      <div className=\"shipping-address\">\r\n        <h3>Địa chỉ giao hàng</h3>\r\n        {selectedAddress ? (\r\n          <div>\r\n            <p>\r\n              <strong>{selectedAddress.fullName}</strong> ({selectedAddress.phone})\r\n            </p>\r\n            <p>{selectedAddress.address}</p>\r\n          </div>\r\n        ) : (\r\n          <p>Chưa có địa chỉ giao hàng.</p>\r\n        )}\r\n      </div>\r\n\r\n      {/* Nút thanh toán */}\r\n      <div className=\"payment-actions\">\r\n        {error && <p className=\"error-message\">{error}</p>}\r\n        <button\r\n          onClick={handlePayment}\r\n          disabled={loading || !selectedAddress}\r\n          className=\"payment-btn\"\r\n        >\r\n          {loading ? \"Đang xử lý...\" : \"Thanh toán với VNPay\"}\r\n        </button>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default Payment;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}